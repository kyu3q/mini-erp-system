<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <title th:text="${order != null ? '受注編集' : '受注登録'}"></title>
</head>
<body>
<div layout:fragment="content">
    <h2 th:text="${order != null ? '受注編集' : '受注登録'}"></h2>

    <form th:action="@{/orders/save}" method="post" id="orderForm">
        <input type="hidden" name="id" th:value="${order?.id}">
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="orderNumber" class="form-label">受注番号</label>
                <input type="text" class="form-control" id="orderNumber" name="orderNumber"
                       th:value="${order?.orderNumber}" readonly>
            </div>
            <div class="col-md-4">
                <label for="orderDate" class="form-label">受注日</label>
                <input type="date" class="form-control" id="orderDate" name="orderDate"
                       th:value="${order?.orderDate}" required>
            </div>
            <div class="col-md-4">
                <label for="customerId" class="form-label">得意先</label>
                <select class="form-select" id="customerId" name="customerId" required>
                    <option value="">選択してください</option>
                    <option th:each="customer : ${customers}"
                            th:value="${customer.id}"
                            th:text="${customer.name}"
                            th:selected="${order?.customerId == customer.id}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="deliveryDate" class="form-label">配送予定日</label>
                <input type="date" class="form-control" id="deliveryDate" name="deliveryDate"
                       th:value="${order?.deliveryDate}">
            </div>
            <div class="col-md-4">
                <label for="status" class="form-label">ステータス</label>
                <select class="form-select" id="status" name="status" required>
                    <option th:each="status : ${statuses}"
                            th:value="${status}"
                            th:text="${status.displayName}"
                            th:selected="${order?.status == status}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="shippingAddress" class="form-label">配送先住所</label>
                <input type="text" class="form-control" id="shippingAddress" name="shippingAddress"
                       th:value="${order?.shippingAddress}">
            </div>
            <div class="col-md-3">
                <label for="shippingPostalCode" class="form-label">配送先郵便番号</label>
                <input type="text" class="form-control" id="shippingPostalCode" name="shippingPostalCode"
                       th:value="${order?.shippingPostalCode}">
            </div>
            <div class="col-md-3">
                <label for="shippingPhone" class="form-label">配送先電話番号</label>
                <input type="text" class="form-control" id="shippingPhone" name="shippingPhone"
                       th:value="${order?.shippingPhone}">
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="shippingContactPerson" class="form-label">配送先担当者</label>
                <input type="text" class="form-control" id="shippingContactPerson" name="shippingContactPerson"
                       th:value="${order?.shippingContactPerson}">
            </div>
            <div class="col-md-6">
                <label for="notes" class="form-label">備考</label>
                <textarea class="form-control" id="notes" name="notes" rows="2"
                          th:text="${order?.notes}"></textarea>
            </div>
        </div>

        <h3>受注明細</h3>
        <div class="table-responsive mb-3">
            <table class="table table-bordered" id="detailsTable">
                <thead>
                <tr>
                    <th>行番号</th>
                    <th>商品</th>
                    <th>数量</th>
                    <th>単価</th>
                    <th>金額</th>
                    <th>倉庫</th>
                    <th>配送予定日</th>
                    <th>備考</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="detail, stat : ${order?.orderDetails}" class="detail-row">
                    <td>
                        <input type="hidden" th:name="|orderDetails[${stat.index}].lineNumber|" th:value="${detail.lineNumber}">
                        <span th:text="${detail.lineNumber}"></span>
                    </td>
                    <td>
                        <select class="form-select" th:name="|orderDetails[${stat.index}].productId|" required>
                            <option value="">選択してください</option>
                            <option th:each="product : ${products}"
                                    th:value="${product.id}"
                                    th:text="${product.itemName}"
                                    th:selected="${detail.productId == product.id}">
                            </option>
                        </select>
                    </td>
                    <td>
                        <input type="number" class="form-control quantity" th:name="|orderDetails[${stat.index}].quantity|"
                               th:value="${detail.quantity}" min="1" required>
                    </td>
                    <td>
                        <input type="number" class="form-control unit-price" th:name="|orderDetails[${stat.index}].unitPrice|"
                               th:value="${detail.unitPrice}" min="0" step="0.01" required>
                    </td>
                    <td>
                        <input type="number" class="form-control amount" th:name="|orderDetails[${stat.index}].amount|"
                               th:value="${detail.amount}" readonly>
                    </td>
                    <td>
                        <select class="form-select" th:name="|orderDetails[${stat.index}].warehouseId|">
                            <option value="">選択してください</option>
                            <option th:each="warehouse : ${warehouses}"
                                    th:value="${warehouse.id}"
                                    th:text="${warehouse.name}"
                                    th:selected="${detail.warehouseId == warehouse.id}">
                            </option>
                        </select>
                    </td>
                    <td>
                        <input type="date" class="form-control" th:name="|orderDetails[${stat.index}].deliveryDate|"
                               th:value="${detail.deliveryDate}">
                    </td>
                    <td>
                        <input type="text" class="form-control" th:name="|orderDetails[${stat.index}].notes|"
                               th:value="${detail.notes}">
                    </td>
                    <td>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeDetail(this)">削除</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="mb-3">
            <button type="button" class="btn btn-secondary" onclick="addDetail()">明細追加</button>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="totalAmount" class="form-label">合計金額</label>
                <input type="number" class="form-control" id="totalAmount" name="totalAmount"
                       th:value="${order?.totalAmount}" readonly>
            </div>
            <div class="col-md-4">
                <label for="taxAmount" class="form-label">消費税額</label>
                <input type="number" class="form-control" id="taxAmount" name="taxAmount"
                       th:value="${order?.taxAmount}" readonly>
            </div>
        </div>

        <div class="mb-3">
            <a th:href="@{/orders}" class="btn btn-secondary">キャンセル</a>
            <button type="submit" class="btn btn-primary">保存</button>
        </div>
    </form>

    <template id="detailRowTemplate">
        <tr class="detail-row">
            <td>
                <input type="hidden" name="orderDetails[INDEX].lineNumber" value="LINE_NUMBER">
                <span>LINE_NUMBER</span>
            </td>
            <td>
                <select class="form-select" name="orderDetails[INDEX].productId" required>
                    <option value="">選択してください</option>
                    <option th:each="product : ${products}"
                            th:value="${product.id}"
                            th:text="${product.itemName}">
                    </option>
                </select>
            </td>
            <td>
                <input type="number" class="form-control quantity" name="orderDetails[INDEX].quantity"
                       value="1" min="1" required>
            </td>
            <td>
                <input type="number" class="form-control unit-price" name="orderDetails[INDEX].unitPrice"
                       value="0" min="0" step="0.01" required>
            </td>
            <td>
                <input type="number" class="form-control amount" name="orderDetails[INDEX].amount"
                       value="0" readonly>
            </td>
            <td>
                <select class="form-select" name="orderDetails[INDEX].warehouseId">
                    <option value="">選択してください</option>
                    <option th:each="warehouse : ${warehouses}"
                            th:value="${warehouse.id}"
                            th:text="${warehouse.name}">
                    </option>
                </select>
            </td>
            <td>
                <input type="date" class="form-control" name="orderDetails[INDEX].deliveryDate">
            </td>
            <td>
                <input type="text" class="form-control" name="orderDetails[INDEX].notes">
            </td>
            <td>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeDetail(this)">削除</button>
            </td>
        </tr>
    </template>

    <script th:inline="javascript">
        function addDetail() {
            const table = document.getElementById('detailsTable');
            const template = document.getElementById('detailRowTemplate');
            const tbody = table.querySelector('tbody');
            const index = tbody.children.length;
            const lineNumber = index + 1;

            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('tr');
            const inputs = row.querySelectorAll('[name*="INDEX"]');
            inputs.forEach(input => {
                input.name = input.name.replace('INDEX', index);
            });

            const lineNumberInputs = row.querySelectorAll('[value="LINE_NUMBER"]');
            lineNumberInputs.forEach(input => {
                input.value = lineNumber;
            });
            const lineNumberSpan = row.querySelector('span');
            lineNumberSpan.textContent = lineNumber;

            tbody.appendChild(row);
            updateAmounts();
        }

        function removeDetail(button) {
            const row = button.closest('tr');
            row.remove();
            updateLineNumbers();
            updateAmounts();
        }

        function updateLineNumbers() {
            const tbody = document.getElementById('detailsTable').querySelector('tbody');
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const lineNumber = index + 1;
                const input = row.querySelector('[name*="].lineNumber"]');
                input.value = lineNumber;
                const span = row.querySelector('td:first-child span');
                span.textContent = lineNumber;

                const inputs = row.querySelectorAll('[name*="orderDetails["]');
                inputs.forEach(input => {
                    input.name = input.name.replace(/orderDetails\[\d+\]/, `orderDetails[${index}]`);
                });
            });
        }

        function updateAmounts() {
            const rows = document.querySelectorAll('.detail-row');
            let total = 0;

            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
                const unitPrice = parseFloat(row.querySelector('.unit-price').value) || 0;
                const amount = quantity * unitPrice;
                row.querySelector('.amount').value = amount.toFixed(2);
                total += amount;
            });

            const taxRate = 0.1; // 10%
            const taxAmount = total * taxRate;
            document.getElementById('totalAmount').value = total.toFixed(2);
            document.getElementById('taxAmount').value = taxAmount.toFixed(2);
        }

        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('quantity') || e.target.classList.contains('unit-price')) {
                updateAmounts();
            }
        });

        // 初期表示時に金額を計算
        document.addEventListener('DOMContentLoaded', function() {
            updateAmounts();
        });
    </script>
</div>
</body>
</html>