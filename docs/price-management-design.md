# 価格管理機能 設計書

## 1. 概要

### 1.1 目的
本機能は、商品の販売価格および購買価格を柔軟に管理するためのものです。以下の要件を満たすように設計されています：
- 品目ごとの基本価格の管理
- 取引先（得意先/仕入先）ごとの個別価格の管理
- 数量に応じた段階的な価格設定
- 有効期間による価格の管理
- 複数通貨への対応

### 1.2 機能範囲
- 価格条件の登録・編集・削除
- 数量スケール価格の設定
- 価格の一括インポート/エクスポート
- 価格履歴の管理
- 有効期限切れ価格の管理

## 2. システム構成

### 2.1 データベース構造

#### 価格条件マスタ (price_conditions)
| カラム名 | 型 | 説明 | 備考 |
|---------|-----|------|------|
| id | BIGINT | 主キー | 自動採番 |
| created_at | TIMESTAMP | 作成日時 | NOT NULL |
| updated_at | TIMESTAMP | 更新日時 | |
| created_by | VARCHAR(100) | 作成者 | |
| updated_by | VARCHAR(100) | 更新者 | |
| deleted | BOOLEAN | 論理削除フラグ | DEFAULT FALSE |
| price_type | VARCHAR(20) | 価格タイプ | 'SALES'/'PURCHASE' |
| item_id | BIGINT | 品目ID | NOT NULL, FK |
| customer_id | BIGINT | 得意先ID | FK, NULL許容 |
| supplier_id | BIGINT | 仕入先ID | FK, NULL許容 |
| base_price | DECIMAL(12,2) | 基本価格 | NOT NULL |
| currency_code | VARCHAR(3) | 通貨コード | DEFAULT 'JPY' |
| valid_from_date | DATE | 有効開始日 | NOT NULL |
| valid_to_date | DATE | 有効終了日 | NOT NULL |
| status | VARCHAR(20) | ステータス | DEFAULT 'ACTIVE' |

#### 数量スケール価格 (price_scales)
| カラム名 | 型 | 説明 | 備考 |
|---------|-----|------|------|
| id | BIGINT | 主キー | 自動採番 |
| created_at | TIMESTAMP | 作成日時 | NOT NULL |
| updated_at | TIMESTAMP | 更新日時 | |
| created_by | VARCHAR(100) | 作成者 | |
| updated_by | VARCHAR(100) | 更新者 | |
| deleted | BOOLEAN | 論理削除フラグ | DEFAULT FALSE |
| price_condition_id | BIGINT | 価格条件ID | NOT NULL, FK |
| from_quantity | DECIMAL(12,3) | 数量範囲（開始） | NOT NULL |
| to_quantity | DECIMAL(12,3) | 数量範囲（終了） | NULL許容 |
| scale_price | DECIMAL(12,2) | スケール価格 | NOT NULL |
| currency_code | VARCHAR(3) | 通貨コード | DEFAULT 'JPY' |

### 2.2 価格条件の優先順位
1. 取引先個別価格（得意先または仕入先指定）
2. 品目基本価格

### 2.3 数量スケールの適用ルール
1. 指定された数量が範囲内の価格を適用
2. 該当する数量範囲がない場合は基本価格を適用
3. to_quantityがNULLの場合、その範囲以上の全ての数量に適用

## 3. 画面設計

### 3.1 価格条件一覧画面
- 検索条件
  - 価格タイプ（販売/購買）
  - 品目コード/名称
  - 取引先コード/名称
  - 有効期間
  - ステータス
- 一覧表示項目
  - 価格タイプ
  - 品目情報
  - 取引先情報
  - 基本価格
  - 通貨
  - 有効期間
  - ステータス
- 機能ボタン
  - 新規登録
  - 編集
  - 削除（論理削除）
  - インポート/エクスポート

### 3.2 価格条件登録/編集画面
- 基本情報セクション
  - 価格タイプ（必須）
  - 品目選択（必須）
  - 取引先選択（任意）
  - 基本価格（必須）
  - 通貨コード（必須）
  - 有効期間（必須）
  - ステータス（必須）
- 数量スケール価格セクション
  - 数量範囲と価格の一覧
  - スケール価格の追加/削除
- 機能ボタン
  - 保存
  - キャンセル

## 4. 機能詳細

### 4.1 価格の検索・照会
1. 価格条件の検索
   - 複数の検索条件を組み合わせて検索可能
   - 有効期間による絞り込み
   - 取引先指定の有無による絞り込み

2. 価格の照会
   - 指定された条件（品目、取引先、数量、日付）に該当する価格を返却
   - 優先順位に従って適用される価格を決定

### 4.2 価格の登録・更新
1. 入力チェック
   - 必須項目の確認
   - 有効期間の妥当性チェック
   - 数量範囲の重複チェック
   - 通貨コードの有効性チェック

2. 重複チェック
   - 同一条件（品目、取引先、期間）の価格設定の重複防止
   - 期間の重複がある場合はエラー

3. 数量スケール価格の管理
   - 数量範囲の連続性チェック
   - 範囲の重複チェック
   - 基本価格との整合性確認

### 4.3 一括処理
1. インポート機能
   - Excelテンプレートを使用
   - データ検証（必須チェック、形式チェック）
   - エラー行のスキップとログ出力

2. エクスポート機能
   - 検索条件に該当するデータの出力
   - Excel形式での出力
   - テンプレートとしても使用可能

### 4.4 履歴管理
1. 変更履歴の保存
   - 変更日時
   - 変更者
   - 変更内容

2. 履歴の照会
   - 価格条件ごとの変更履歴表示
   - 変更前後の値の比較

## 5. 非機能要件

### 5.1 性能要件
- 一覧画面の表示：1秒以内
- 価格検索：0.5秒以内
- 一括処理：1000件/分以上

### 5.2 セキュリティ要件
- 価格情報へのアクセス制限
- 操作ログの記録
- 変更履歴の保持

### 5.3 運用要件
- バッチ処理による有効期限切れ通知
- 定期的なデータバックアップ
- アクセスログの保持

## 6. 今後の拡張性

### 6.1 将来的な機能拡張
1. 価格計算ロジックの拡張
   - 複数の計算方式（掛率、マージン等）
   - 通貨換算レートの自動適用

2. 承認ワークフロー
   - 価格変更の承認プロセス
   - 承認権限の管理

3. 分析機能
   - 価格トレンド分析
   - 収益性分析
   - 価格シミュレーション

### 6.2 システム連携
1. 外部システムとの連携
   - ERPシステム
   - 会計システム
   - 在庫管理システム

2. API提供
   - 価格照会API
   - 価格更新API
   - 一括処理API