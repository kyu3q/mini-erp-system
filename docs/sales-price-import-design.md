# 販売単価取込処理 設計書

## 1. 概要

### 1.1 目的
本機能は、Excelファイルから販売単価データを一括で取込み、システムに登録・更新するための機能です。ユーザーが作成した販売単価データをシステムに効率的に取込むことで、データ入力の手間を削減し、業務効率の向上を図ります。

### 1.2 機能範囲
- Excelファイルからの販売単価データの読み込み
- データの検証と変換
- 既存データの更新と新規データの登録
- 処理結果の集計と返却

## 2. システム構成

### 2.1 関連コンポーネント
- **SalesPriceImportController**: 取込処理のエンドポイントを提供
- **SalesPriceImportService**: 取込処理のビジネスロジックを実装
- **SalesPriceService**: 販売単価の基本操作を提供
- **SalesPriceRepository**: 販売単価データのデータアクセスを提供
- **PriceScaleRepository**: 数量スケール情報のデータアクセスを提供
- **ItemRepository**: 品目情報のデータアクセスを提供
- **CustomerRepository**: 得意先情報のデータアクセスを提供

### 2.2 クラス図
```
┌─────────────────────┐      ┌─────────────────────┐
│SalesPriceImportController│──→│SalesPriceImportService│
└─────────────────────┘      └──────────┬──────────┘
                                        │
                                        ↓
┌─────────────────┐      ┌─────────────────┐
│SalesPriceService│←─────│SalesPriceRepository│
└─────────────────┘      └─────────────────┘
        ↓                         ↑
┌─────────────────┐               │
│PriceScaleRepository│─────────────┘
└─────────────────┘
        ↓
┌─────────────────┐      ┌─────────────────┐
│ ItemRepository  │      │CustomerRepository│
└─────────────────┘      └─────────────────┘
```

## 3. 処理フロー

### 3.1 全体フロー
1. ユーザーがExcelファイルをアップロード
2. コントローラーがファイル形式を検証
3. サービスがファイルを読み込み、データを検証
4. 各行のデータを処理（既存データの更新または新規データの登録）
5. 処理結果を集計して返却

### 3.2 詳細フロー図
```
┌──────┐    ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐
│開始   │───→│ファイル検証│───→│ヘッダー検証│───→│データ行処理│───→│結果返却 │
└──────┘    └────────┘    └────────┘    └────────┘    └────────┘
                                             │
                                             ↓
                              ┌───────────────────────────┐
                              │         データ行処理        │
                              └───────────────────────────┘
                                             │
                                             ↓
                   ┌────────────────┐                ┌────────────────┐
                   │  既存データ検索  │───→ 存在する ───→│ 既存データ更新  │
                   └────────────────┘                └────────────────┘
                             │
                          存在しない
                             │
                             ↓
                   ┌────────────────┐
                   │  新規データ登録  │
                   └────────────────┘
```

## 4. データ構造

### 4.1 入力ファイル形式
- ファイル形式: Excel (.xls, .xlsx)
- シート名: 販売単価
- ヘッダー行: 1行目

#### 4.1.1 ヘッダー項目
| 項目名 | 必須 | 説明 |
|-------|------|------|
| 品目コード | ○ | 品目マスタに登録されている品目コード |
| 得意先コード | × | 得意先マスタに登録されている得意先コード（標準価格の場合は空欄） |
| 基本価格 | ○ | 基本販売価格（数量スケールに該当しない場合の価格） |
| 通貨コード | × | 通貨コード（デフォルト: JPY） |
| 有効開始日 | ○ | 価格の有効開始日（YYYY/MM/DD形式） |
| 有効終了日 | ○ | 価格の有効終了日（YYYY/MM/DD形式） |
| ステータス | × | 価格のステータス（ACTIVE/INACTIVE、デフォルト: ACTIVE） |
| 数量範囲開始1 | × | 数量スケール1の開始数量 |
| 数量範囲終了1 | × | 数量スケール1の終了数量（上限なしの場合は空欄） |
| スケール価格1 | × | 数量スケール1の価格 |
| 数量範囲開始2 | × | 数量スケール2の開始数量 |
| 数量範囲終了2 | × | 数量スケール2の終了数量（上限なしの場合は空欄） |
| スケール価格2 | × | 数量スケール2の価格 |
| 数量範囲開始3 | × | 数量スケール3の開始数量 |
| 数量範囲終了3 | × | 数量スケール3の終了数量（上限なしの場合は空欄） |
| スケール価格3 | × | 数量スケール3の価格 |

### 4.2 内部データ構造

#### 4.2.1 SalesPriceData（行データ）
```java
class SalesPriceData {
    private int rowIndex;                      // 行番号
    private String itemCode;                   // 品目コード
    private String customerCode;               // 得意先コード
    private BigDecimal basePrice;              // 基本価格
    private String currencyCode;               // 通貨コード
    private LocalDate validFromDate;           // 有効開始日
    private LocalDate validToDate;             // 有効終了日
    private String status;                     // ステータス
    private List<PriceScaleData> priceScales;  // 数量スケール情報
}
```

#### 4.2.2 PriceScaleData（スケールデータ）
```java
class PriceScaleData {
    private BigDecimal fromQuantity;  // 開始数量
    private BigDecimal toQuantity;    // 終了数量
    private BigDecimal scalePrice;    // スケール価格
}
```

#### 4.2.3 ImportResult（取込結果）
```java
class ImportResult {
    private int totalCount;                // 総処理件数
    private int successCount;              // 成功件数
    private int errorCount;                // 失敗件数
    private List<ErrorDetail> errors;      // エラー詳細
    private List<String> globalErrors;     // グローバルエラー
}
```

#### 4.2.4 ErrorDetail（エラー詳細）
```java
class ErrorDetail {
    private int rowNum;      // エラー発生行
    private String message;  // エラーメッセージ
}
```

## 5. バリデーションルール

### 5.1 ファイル検証
- ファイルが空でないこと
- ファイル形式がExcel (.xls, .xlsx) であること
- シート「販売単価」が存在すること
- ヘッダー行が存在し、必須ヘッダーが含まれていること

### 5.2 データ検証

#### 5.2.1 基本項目の検証
- 品目コード: 必須、マスタに存在すること
- 得意先コード: 任意、指定された場合はマスタに存在すること
- 基本価格: 必須、0以上の数値
- 通貨コード: 任意、指定されない場合は「JPY」
- 有効開始日: 必須、日付形式（YYYY/MM/DD）
- 有効終了日: 必須、日付形式（YYYY/MM/DD）
- ステータス: 任意、指定されない場合は「ACTIVE」

#### 5.2.2 有効期間の検証
- 有効開始日 <= 有効終了日

#### 5.2.3 数量スケールの検証
- 開始数量: スケールが指定される場合は必須、0より大きい数値
- 終了数量: 任意、指定される場合は開始数量より大きい数値
- スケール価格: スケールが指定される場合は必須、0以上の数値
- スケール間の重複がないこと

## 6. 既存データの更新ルール

### 6.1 一意キーの定義
販売単価の一意キーは以下の組み合わせとする:
- 品目コード
- 得意先コード（標準価格の場合はnull）
- 有効開始日
- 有効終了日

### 6.2 更新条件
- 一意キーが完全に一致する場合のみ更新を行う
- 一意キーが部分的に一致（期間が重複）する場合はエラーとする

### 6.3 更新対象項目
- 基本価格
- 通貨コード
- ステータス
- 数量スケール情報（全て削除して再作成）

## 7. 新規登録ルール

### 7.1 登録条件
- 一意キーに該当するデータが存在しない場合
- 同一品目・得意先でも期間が重複しない場合

### 7.2 登録項目
- 品目情報（品目ID、品目コード）
- 得意先情報（得意先ID、得意先コード）※指定されている場合
- 基本価格
- 通貨コード
- 有効期間（開始日、終了日）
- ステータス
- 数量スケール情報

## 8. エラーハンドリング

### 8.1 エラーの種類
1. グローバルエラー: ファイル全体に関するエラー
2. 行エラー: 特定の行に関するエラー

### 8.2 エラーメッセージ
| エラーコード | メッセージ | 説明 |
|------------|------------|------|
| G001 | ファイルが空です | 空のファイルがアップロードされた場合 |
| G002 | Excelファイル形式ではありません | 不正なファイル形式の場合 |
| G003 | シート「販売単価」が見つかりません | 指定シートが存在しない場合 |
| G004 | ヘッダー行が見つかりません | ヘッダー行が存在しない場合 |
| G005 | 必須ヘッダー「{0}」が見つかりません | 必須ヘッダーが不足している場合 |
| R001 | 品目コードは必須です | 品目コードが空の場合 |
| R002 | 基本価格は必須です | 基本価格が空の場合 |
| R003 | 有効開始日は必須です | 有効開始日が空の場合 |
| R004 | 有効終了日は必須です | 有効終了日が空の場合 |
| R005 | 基本価格は0以上の値を指定してください | 基本価格が負の値の場合 |
| R006 | 有効開始日は有効終了日より前の日付を指定してください | 有効期間の矛盾がある場合 |
| R007 | 品目コードが存在しません: {0} | マスタに存在しない品目コードの場合 |
| R008 | 得意先コードが存在しません: {0} | マスタに存在しない得意先コードの場合 |
| R009 | 数量範囲開始{0}は必須です | スケール情報が不完全な場合 |
| R010 | スケール価格{0}は必須です | スケール情報が不完全な場合 |
| R011 | 数量範囲開始{0}は0より大きい値を指定してください | スケール開始数量が不正な場合 |
| R012 | スケール価格{0}は0以上の値を指定してください | スケール価格が不正な場合 |
| R013 | 数量範囲開始{0}は数量範囲終了{0}より小さい値を指定してください | スケール範囲が不正な場合 |
| R014 | 数量範囲が重複しています | スケール間で範囲が重複している場合 |
| R015 | 期間が重複する販売単価が既に存在します | 期間重複がある場合 |

### 8.3 エラー処理方針
1. ファイル検証エラー: 処理を中断し、エラーメッセージを返却
2. 行データエラー: エラーのある行をスキップし、他の行の処理を継続
3. 全体エラー: 全ての行の処理が完了した後、成功/失敗の集計結果を返却

## 9. トランザクション管理

### 9.1 トランザクション境界
- 取込処理全体を単一トランザクションで管理
- 1行でもエラーがあれば全体をロールバック

### 9.2 スケール情報の処理
- 既存のスケール情報の削除は別トランザクションで実行
- 新しいスケール情報の登録も別トランザクションで実行
- エンティティマネージャのキャッシュをクリアして整合性を確保

## 10. 性能と拡張性

### 10.1 性能考慮事項
- 一度に処理する行数の制限（推奨: 1000行まで）
- 大量データ処理時のメモリ使用量の最適化
- データベースアクセスの最適化（インデックスの活用）

### 10.2 将来的な拡張性
1. 行単位のトランザクション処理オプション
2. CSV形式のサポート
3. 取込テンプレートのカスタマイズ
4. バッチ処理による定期的な取込

## 11. テスト方針

### 11.1 単体テスト
- ファイル読み込みのテスト
- データ変換のテスト
- バリデーションロジックのテスト
- 既存データ更新ロジックのテスト
- 新規データ登録ロジックのテスト

### 11.2 統合テスト
- エンドツーエンドのフローテスト
- エラーケースのテスト
- トランザクション管理のテスト

### 11.3 性能テスト
- 大量データ処理のテスト
- メモリ使用量のテスト
- 処理時間の計測

## 12. セキュリティ考慮事項

### 12.1 入力検証
- すべての入力値の厳格なバリデーション
- 特殊文字のエスケープ処理

### 12.2 アクセス制御
- 取込機能の権限管理
- 操作ログの記録

## 13. 運用上の注意点

### 13.1 バックアップ
- 取込前のデータバックアップ推奨
- 障害時の復旧手順

### 13.2 処理時間
- 大量データ処理時の処理時間目安
- システム負荷の考慮

### 13.3 エラー対応
- エラー発生時の対応フロー
- サポート窓口の案内 